## 阶段 P5: 传输功能

### P5-1: 实现 TransferManager 核心
- **状态**: [ ]
- **类型**: 后端
- **等级**: L3 (高标准层 - 核心传输)
- **依赖**: P1-1, P0-3
- **描述**: 传输队列管理器核心框架
- **产出**:
  - 文件: `src-tauri/src/services/transfer_manager.rs`
  - TransferTask 状态机:
    ```rust
    enum TransferStatus {
        Waiting,
        Running,
        Success,
        Failed,
        Canceled,
    }
    struct TransferTask {
        task_id: String,
        session_id: String,
        direction: TransferDirection,  // Upload / Download
        local_path: PathBuf,
        remote_path: String,
        status: TransferStatus,
        transferred: u64,
        total: Option<u64>,
        error: Option<AppError>,
        cancel_token: CancellationToken,
    }
    ```
  - 任务队列: `Arc<RwLock<HashMap<String, TransferTask>>>`
- **验收标准**:
  - 功能:
    - [ ] 任务创建返回唯一 task_id
    - [ ] 状态机: Waiting → Running → Success/Failed/Canceled
    - [ ] 状态单向流转，无逆向
    - [ ] 任务队列支持并发访问
    - [ ] 获取任务列表/单个任务
  - 性能:
    - [ ] 任务队列读写锁优化
    - [ ] 状态更新不阻塞传输线程
  - 错误处理:
    - [ ] 任务不存在返回 NOT_FOUND
    - [ ] 状态流转异常有明确日志
  - 可维护:
    - [ ] 状态机逻辑封装为方法
    - [ ] CancellationToken 正确初始化
  - 测试:
    - [ ] 状态机流转测试
    - [ ] 并发访问测试
    - [ ] 内存泄漏检测
- **备注**:

---

### P5-2: 实现并发控制
- **状态**: [ ]
- **类型**: 后端
- **等级**: L3 (高标准层 - 性能敏感)
- **依赖**: P5-1, P1-4
- **描述**: 传输任务并发数控制
- **产出**:
  - 使用 `tokio::sync::Semaphore`
  - 从 Settings 读取 `max_concurrent_transfers`
  - 默认 3，范围 1-6
- **验收标准**:
  - 功能:
    - [ ] Semaphore 正确限制并发数
    - [ ] 从 Settings 动态读取配置
    - [ ] 等待中任务按 FIFO 顺序执行
    - [ ] permit 释放后立即调度下一任务
  - 性能:
    - [ ] 并发数达上限时新任务不阻塞创建
    - [ ] permit 获取/释放无死锁
  - 边界条件:
    - [ ] 配置变更时现有任务不受影响
    - [ ] 并发数 1-6 边界校验
  - 测试:
    - [ ] 并发数限制测试
    - [ ] 队列调度顺序测试
    - [ ] 动态配置测试
- **备注**:

---

### P5-3: 实现上传功能
- **状态**: [ ]
- **类型**: 后端
- **等级**: L3 (高标准层 - 核心传输)
- **依赖**: P5-1, P3-1
- **描述**: 文件上传核心逻辑
- **产出**:
  - 文件: `src-tauri/src/commands/transfer.rs`
  - 命令: `transfer_upload(session_id: String, local_path: String, remote_dir: String) -> String` (返回 task_id)
  - 流程:
    1. 创建任务，加入队列
    2. 获取 Semaphore permit
    3. 打开本地文件 (流式读取)
    4. 创建远端文件 (sftp.create)
    5. 分块传输 (64KB/块)
    6. 更新进度，推送事件
- **验收标准**:
  - 功能:
    - [ ] 返回 task_id 立即返回，不阻塞
    - [ ] 流式读取本地文件
    - [ ] 远端文件正确创建
    - [ ] 分块传输 (64KB/块)
    - [ ] 进度正确计算
    - [ ] 传输完成校验文件大小
  - 性能:
    - [ ] 流式传输，内存占用 <10MB (固定缓冲区)
    - [ ] 大文件 (>1GB) 传输稳定
    - [ ] 传输速度接近网络带宽上限
  - 安全:
    - [ ] 本地路径校验 (防止读取敏感文件)
    - [ ] 远端路径遍历防护
  - 边界条件:
    - [ ] 本地文件不存在返回 NOT_FOUND
    - [ ] 远端目录不存在返回 NOT_FOUND
    - [ ] 远端文件已存在时覆盖 (可配置)
    - [ ] 空文件上传成功
    - [ ] 文件名含特殊字符正确处理
  - 错误处理:
    - [ ] 本地读取失败返回 LOCAL_IO_ERROR
    - [ ] 远端写入失败返回 REMOTE_IO_ERROR
    - [ ] 网络中断返回 NETWORK_LOST
    - [ ] 磁盘满返回明确错误
  - 测试:
    - [ ] 小文件上传测试
    - [ ] 大文件上传测试
    - [ ] 中断恢复测试
    - [ ] 内存占用测试
- **备注**:

---

### P5-4: 实现下载功能
- **状态**: [ ]
- **类型**: 后端
- **等级**: L3 (高标准层 - 核心传输)
- **依赖**: P5-1, P3-1
- **描述**: 文件下载核心逻辑
- **产出**:
  - 命令: `transfer_download(session_id: String, remote_path: String, local_dir: String) -> String` (返回 task_id)
  - 流程:
    1. 创建任务，加入队列
    2. 获取 Semaphore permit
    3. 打开远端文件 (sftp.open)
    4. 创建本地文件 (流式写入)
    5. 分块传输
    6. 更新进度，推送事件
- **验收标准**:
  - 功能:
    - [ ] 返回 task_id 立即返回，不阻塞
    - [ ] 流式读取远端文件
    - [ ] 本地文件正确创建
    - [ ] 分块传输 (64KB/块)
    - [ ] 进度正确计算
    - [ ] 传输完成校验文件大小
  - 性能:
    - [ ] 流式传输，内存占用 <10MB
    - [ ] 大文件 (>1GB) 传输稳定
    - [ ] 传输速度接近网络带宽上限
  - 安全:
    - [ ] 本地路径校验 (防止写入敏感位置)
    - [ ] 远端路径遍历防护
  - 边界条件:
    - [ ] 远端文件不存在返回 NOT_FOUND
    - [ ] 本地目录不存在返回 NOT_FOUND
    - [ ] 本地文件已存在时覆盖 (可配置)
    - [ ] 空文件下载成功
    - [ ] 保留原文件名
  - 错误处理:
    - [ ] 远端读取失败返回 REMOTE_IO_ERROR
    - [ ] 本地写入失败返回 LOCAL_IO_ERROR
    - [ ] 网络中断返回 NETWORK_LOST
    - [ ] 磁盘满返回明确错误
  - 测试:
    - [ ] 小文件下载测试
    - [ ] 大文件下载测试
    - [ ] 中断恢复测试
    - [ ] 内存占用测试
- **备注**:

---

### P5-5: 实现进度推送
- **状态**: [ ]
- **类型**: 后端
- **等级**: L2 (标准层)
- **依赖**: P5-3, P5-4
- **描述**: 传输进度事件推送
- **产出**:
  - 事件: `transfer:progress`
  - payload:
    ```json
    {
      "task_id": "xxx",
      "transferred": 1024000,
      "total": 2048000,
      "speed": 512000,
      "percent": 50
    }
    ```
  - 节流: 200ms 推送一次 (使用 Instant 计时)
- **验收标准**:
  - 功能:
    - [ ] 事件包含完整 payload
    - [ ] transferred/total 单位为字节
    - [ ] speed 单位为 bytes/s
    - [ ] percent 为 0-100 整数
    - [ ] 首次和完成时立即推送
  - 性能:
    - [ ] 节流 200ms，避免事件风暴
    - [ ] 事件推送不阻塞传输线程
    - [ ] IPC 序列化开销可控
  - 边界条件:
    - [ ] total 未知时为 null
    - [ ] 速度计算使用滑动窗口平均
  - 测试:
    - [ ] 事件格式测试
    - [ ] 节流效果测试
- **备注**:

---

### P5-6: 实现状态推送
- **状态**: [ ]
- **类型**: 后端
- **等级**: L2 (标准层)
- **依赖**: P5-3, P5-4
- **描述**: 传输状态变更事件推送
- **产出**:
  - 事件: `transfer:status`
  - payload:
    ```json
    {
      "task_id": "xxx",
      "status": "success" | "failed" | "canceled",
      "error": { "code": "...", "message": "..." }  // 仅失败时
    }
    ```
- **验收标准**:
  - 功能:
    - [ ] 状态变更时立即推送
    - [ ] status 枚举值正确
    - [ ] 失败时包含 error 对象
    - [ ] error 包含 code + message
    - [ ] 成功/取消时 error 为 null
  - 错误处理:
    - [ ] error.retryable 标识正确
    - [ ] 错误消息用户友好
  - 测试:
    - [ ] 各状态事件测试
    - [ ] 错误内容测试
- **备注**:

---

### P5-7: 实现取消功能
- **状态**: [ ]
- **类型**: 后端
- **等级**: L3 (高标准层 - 资源管理)
- **依赖**: P5-5, P5-6
- **描述**: 取消正在进行的传输任务
- **产出**:
  - 命令: `transfer_cancel(task_id: String) -> ()`
  - 使用 `tokio_util::sync::CancellationToken`
  - 取消后:
    1. 设置 cancel_token
    2. 等待任务结束
    3. 释放文件句柄
    4. 推送 canceled 状态
- **验收标准**:
  - 功能:
    - [ ] 取消命令立即返回
    - [ ] 传输线程检测到取消后停止
    - [ ] 状态变更为 Canceled
    - [ ] 推送 transfer:status 事件
  - 性能:
    - [ ] 取消响应时间 <500ms
    - [ ] 取消后立即释放 Semaphore permit
  - 资源管理:
    - [ ] 本地文件句柄正确关闭
    - [ ] 远端文件句柄正确关闭
    - [ ] 部分上传的远端文件删除 (可配置)
    - [ ] 部分下载的本地文件删除 (可配置)
  - 边界条件:
    - [ ] 任务不存在返回 NOT_FOUND
    - [ ] 重复取消静默成功 (幂等)
    - [ ] Waiting 状态任务可取消
    - [ ] Success/Failed 状态任务取消静默
  - 测试:
    - [ ] 取消正在传输的任务测试
    - [ ] 取消等待中的任务测试
    - [ ] 资源释放验证测试
- **备注**:

---

### P5-8: 实现重试功能
- **状态**: [ ]
- **类型**: 后端
- **等级**: L2 (标准层)
- **依赖**: P5-6
- **描述**: 失败任务重试
- **产出**:
  - 命令: `transfer_retry(task_id: String) -> String` (返回新 task_id)
  - 自动重试:
    - 失败时检查 `error.retryable`
    - 若 true，最多重试 2 次
    - 指数退避: 1s, 2s
  - 手动重试: 创建新任务，复用原路径
- **验收标准**:
  - 功能:
    - [ ] 手动重试创建新任务
    - [ ] 新任务复用原有路径
    - [ ] 返回新 task_id
    - [ ] 自动重试: retryable=true 时触发
    - [ ] 最大重试次数 2 次
    - [ ] 指数退避: 1s, 2s, 4s
  - 边界条件:
    - [ ] 原任务不存在返回 NOT_FOUND
    - [ ] 原任务非 Failed 状态返回错误
    - [ ] 超过重试次数后标记最终失败
    - [ ] retryable=false 不自动重试
  - 错误处理:
    - [ ] 重试失败保留最后一次错误
    - [ ] 重试计数器正确维护
  - 测试:
    - [ ] 手动重试测试
    - [ ] 自动重试测试
    - [ ] 退避策略测试
- **备注**:

---

### P5-9: 前端传输事件监听
- **状态**: [ ]
- **类型**: 前端
- **等级**: L2 (标准层)
- **依赖**: P0-4
- **描述**: 监听后端传输事件
- **产出**:
  - `src/hooks/useTransferEvents.ts`
  - 使用 `@tauri-apps/api/event` 监听
  - 事件: `transfer:progress`, `transfer:status`
  - 更新本地任务状态 (zustand 或 Context)
- **验收标准**:
  - 功能:
    - [ ] 监听 transfer:progress 事件
    - [ ] 监听 transfer:status 事件
    - [ ] 事件解析 payload 正确
    - [ ] 更新本地任务状态
    - [ ] 组件卸载时取消监听
  - 性能:
    - [ ] 事件处理不阻塞渲染
    - [ ] 批量更新减少重渲染
  - 错误处理:
    - [ ] 事件解析失败有日志
    - [ ] 未知任务 ID 静默忽略
  - 可维护:
    - [ ] TypeScript 类型完整
    - [ ] 事件类型定义复用
  - 测试:
    - [ ] 事件接收测试
    - [ ] 状态更新测试
- **备注**:

---

### P5-10: 前端任务中心组件
- **状态**: [ ]
- **类型**: 前端
- **等级**: L2 (标准层)
- **依赖**: P5-9
- **描述**: 传输队列 UI
- **产出**:
  - `src/components/TransferQueue.tsx`
  - 分组: 进行中 / 已完成 / 失败
  - 每项显示: 文件名、方向图标、进度条、速度、百分比
  - 按钮: 取消 (进行中)、重试 (失败)
  - 可折叠面板
- **验收标准**:
  - 功能:
    - [ ] 分组显示: 进行中/已完成/失败
    - [ ] 任务项: 文件名、方向图标、进度条
    - [ ] 进度显示: 速度、百分比、已传/总量
    - [ ] 取消按钮 (进行中任务)
    - [ ] 重试按钮 (失败任务)
    - [ ] 面板可折叠展开
    - [ ] 展开时显示详细错误信息
  - 性能:
    - [ ] 进度更新平滑动画
    - [ ] 大量任务时使用虚拟列表
    - [ ] 更新不闪烁
  - 边界条件:
    - [ ] 无任务时显示空状态
    - [ ] 长文件名截断 + tooltip
    - [ ] 速度为 0 时显示 "等待中"
  - 可维护:
    - [ ] 任务项抽象为子组件
    - [ ] 进度条组件复用
  - 测试:
    - [ ] 各状态渲染测试
    - [ ] 交互按钮测试
- **备注**:

---

