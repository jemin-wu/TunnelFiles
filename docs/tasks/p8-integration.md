## 阶段 P8: 集成与测试

### P8-1: 前后端联调 - 连接流程
- **状态**: [ ]
- **类型**: 联调
- **等级**: L3 (高标准层 - 安全关键路径)
- **依赖**: P2-7, P7-4
- **描述**: 完整连接流程联调
- **验收标准**:
  - 功能:
    - [ ] 新增连接保存正确
    - [ ] 编辑连接更新正确
    - [ ] 测试连接返回成功/失败原因
    - [ ] 首次连接弹出 HostKey 确认
    - [ ] HostKey 确认后写入 known_hosts
    - [ ] 密码认证成功进入文件管理页
    - [ ] Key 认证成功进入文件管理页
    - [ ] 断开连接后会话正确清理
  - 安全:
    - [ ] 密码不明文存储验证
    - [ ] HostKey 变更阻断并警告
    - [ ] 错误的凭据返回明确错误
  - 错误处理:
    - [ ] 网络不可达: TIMEOUT 错误
    - [ ] 认证失败: AUTH_FAILED 错误
    - [ ] 端口错误: 连接拒绝错误
  - 性能:
    - [ ] 连接超时 <30s
    - [ ] 连接成功后立即可操作
  - 测试:
    - [ ] 完整连接流程冒烟测试
    - [ ] 异常场景测试
- **备注**:

---

### P8-2: 前后端联调 - 文件操作
- **状态**: [ ]
- **类型**: 联调
- **等级**: L2 (标准层)
- **依赖**: P4-4, P7-5
- **描述**: 文件浏览与操作联调
- **验收标准**:
  - 功能:
    - [ ] 目录列表正确加载
    - [ ] 文件属性完整显示
    - [ ] 双击进入子目录
    - [ ] 面包屑点击跳转
    - [ ] 刷新按钮更新列表
    - [ ] 表头排序 (名称/大小/时间)
    - [ ] 新建文件夹成功
    - [ ] 重命名文件/目录成功
    - [ ] 删除文件成功
    - [ ] 删除空目录成功
    - [ ] 非空目录返回 DIR_NOT_EMPTY
  - 边界条件:
    - [ ] 根目录面包屑正确
    - [ ] 空目录显示空态
    - [ ] 权限不足操作拒绝
    - [ ] 重名冲突提示
  - 性能:
    - [ ] 大目录 (>1000) 加载 <2s
    - [ ] 操作后列表刷新 <500ms
  - 测试:
    - [ ] 文件浏览冒烟测试
    - [ ] 各操作流程测试
    - [ ] 错误场景测试
- **备注**:

---

### P8-3: 前后端联调 - 传输功能
- **状态**: [ ]
- **类型**: 联调
- **等级**: L3 (高标准层 - 核心传输)
- **依赖**: P5-10, P7-6
- **描述**: 上传下载完整流程联调
- **验收标准**:
  - 功能:
    - [ ] 拖拽单文件上传成功
    - [ ] 拖拽多文件上传逐个创建任务
    - [ ] 手动选择上传成功
    - [ ] 下载单文件到指定目录
    - [ ] 进度条实时更新
    - [ ] 速度显示正确
    - [ ] 取消任务立即停止
    - [ ] 重试失败任务成功
    - [ ] 并发数不超过配置值
  - 性能:
    - [ ] 小文件 (<1MB) 传输 <1s
    - [ ] 大文件 (>100MB) 传输稳定
    - [ ] 进度更新不卡顿
    - [ ] 内存占用稳定
  - 边界条件:
    - [ ] 0 字节文件正确处理
    - [ ] 文件名含特殊字符正确
    - [ ] 目标已存在时行为明确
    - [ ] 磁盘满时错误提示
  - 错误处理:
    - [ ] 网络中断: 任务失败可重试
    - [ ] 权限不足: 明确错误提示
    - [ ] 本地文件不存在: 快速失败
  - 测试:
    - [ ] 传输功能冒烟测试
    - [ ] 并发传输压力测试
    - [ ] 异常场景测试
- **备注**:

---

### P8-4: 单元测试 - 后端
- **状态**: [ ]
- **类型**: 测试
- **等级**: L2 (标准层)
- **依赖**: P5-8
- **描述**: 后端核心模块单元测试
- **产出**:
  - `src-tauri/src/services/transfer_manager_test.rs`
  - 测试用例:
    - [ ] 任务状态机流转
    - [ ] 错误映射正确性
    - [ ] 取消逻辑
    - [ ] 重试逻辑
    - [ ] 并发控制
- **验收标准**:
  - 功能:
    - [ ] TransferManager 状态机测试
    - [ ] 错误码映射测试
    - [ ] 取消功能测试
    - [ ] 重试逻辑测试
    - [ ] 并发控制测试
    - [ ] SecurityService 单测
    - [ ] StorageService 单测
  - 覆盖率:
    - [ ] 核心模块覆盖率 ≥70%
    - [ ] 关键路径覆盖率 ≥85%
    - [ ] 分支覆盖
  - 可维护:
    - [ ] 测试用例命名规范
    - [ ] Mock 接口清晰
    - [ ] 测试数据隔离
  - 测试:
    - [ ] `cargo test` 全部通过
    - [ ] CI 集成测试
- **备注**:

---

### P8-5: 集成测试
- **状态**: [ ]
- **类型**: 测试
- **等级**: L3 (高标准层)
- **依赖**: P8-3
- **描述**: 端到端集成测试
- **产出**:
  - Docker 容器化 OpenSSH 服务
  - CI 配置 (GitHub Actions)
  - 冒烟测试脚本
  - 测试场景:
    - [ ] 连接 → 浏览 → 上传 → 下载
    - [ ] 断网恢复
    - [ ] 权限错误处理
- **验收标准**:
  - 功能:
    - [ ] Docker OpenSSH 容器配置
    - [ ] GitHub Actions CI 配置
    - [ ] 端到端冒烟测试脚本
    - [ ] 测试: 连接 → 浏览 → 上传 → 下载
    - [ ] 测试: 网络中断后重连
    - [ ] 测试: 权限错误场景
    - [ ] 测试: 大文件传输
  - 覆盖:
    - [ ] 密码认证路径
    - [ ] Key 认证路径
    - [ ] HostKey 首次确认
    - [ ] 各文件操作
    - [ ] 传输队列并发
  - 可维护:
    - [ ] 测试环境一键搭建
    - [ ] 测试数据自动清理
    - [ ] 测试报告生成
  - 测试:
    - [ ] CI 全流程通过
    - [ ] 本地可复现
- **备注**:

---

### P8-6: 性能优化
- **状态**: [ ]
- **类型**: 优化
- **等级**: L3 (高标准层 - 性能敏感)
- **依赖**: P8-3
- **描述**: 性能问题排查与优化
- **验收标准**:
  - 性能:
    - [ ] 大目录 (5000+) 渲染 60fps
    - [ ] 大目录滚动无白屏
    - [ ] 进度事件节流 200ms
    - [ ] 大文件传输内存占用 <50MB
    - [ ] 多任务并发内存稳定
    - [ ] 应用启动时间 <2s
  - 资源管理:
    - [ ] 无内存泄漏 (长时间运行稳定)
    - [ ] 无文件句柄泄漏
    - [ ] 会话断开后资源释放
    - [ ] 取消任务资源清理
  - 基准测试:
    - [ ] 建立性能基准数据
    - [ ] 回归测试不劣化
  - 可维护:
    - [ ] 性能瓶颈记录
    - [ ] 优化方案文档
  - 测试:
    - [ ] 压力测试通过
    - [ ] 内存分析报告
    - [ ] 火焰图分析
- **备注**:

---

## 附录

### A. 任务状态统计

```
总任务数: 61
已完成: 15
进行中: 0
待开始: 46
阻塞: 0
```

### B. 里程碑

| 里程碑 | 阶段 | 状态 |
|-------|-----|------|
| M1 - 可连接 | P0 + P1 + P2 | [ ] |
| M2 - 可浏览 | P3 | [ ] |
| M3 - 可操作 | P4 | [ ] |
| M4 - 可传输 | P5 | [ ] |
| M5 - MVP | P6 + P7 + P8 | [ ] |

### C. 关键依赖路径

```
P0-1 → P0-3 → P0-5 → P1-1 → P1-3 → P2-1 → P2-3 → P2-7 → P3-1 → P3-2
                                                              ↓
P0-1 → P0-2 → P0-4 → P1-6 → P3-4 → P3-5 → P4-4 → P7-5 → P8-2
                                                    ↓
                              P5-1 → P5-3 → P5-5 → P5-10 → P7-6 → P8-3
```

### D. 风险清单

| 风险 | 影响 | 缓解措施 |
|-----|-----|---------|
| ssh2 库编译问题 | 高 | 提前验证编译环境 |
| 跨平台安全存储差异 | 中 | 分平台测试 |
| 大文件内存占用 | 中 | 流式传输，限制缓冲区 |
| 网络异常处理复杂 | 中 | 完善错误类型和重试策略 |
