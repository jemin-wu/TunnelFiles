## 阶段 P6: 设置与偏好

### P6-1: 实现 settings_get 命令
- **状态**: [x]
- **类型**: 后端
- **等级**: L1 (基础层)
- **依赖**: P1-4
- **描述**: 读取设置
- **产出**:
  - 文件: `src-tauri/src/commands/settings.rs`
  - 命令: `settings_get() -> Settings`
- **验收标准**:
  - 功能:
    - [x] 返回完整 Settings 结构
    - [x] 缺失配置文件时返回默认值
  - 错误处理:
    - [x] 配置文件损坏时返回默认值 + 警告日志
  - 测试:
    - [x] 正常读取测试
    - [x] 默认值测试
- **备注**:

---

### P6-2: 实现 settings_set 命令
- **状态**: [x]
- **类型**: 后端
- **等级**: L1 (基础层)
- **依赖**: P1-4
- **描述**: 更新设置
- **产出**:
  - 命令: `settings_set(patch: SettingsPatch) -> ()`
  - 合并更新，原子写入
- **验收标准**:
  - 功能:
    - [x] 支持部分更新 (patch)
    - [x] 未提供字段保持原值
    - [x] 返回更新后的完整 Settings
  - 边界条件:
    - [x] 值范围校验 (如 max_concurrent: 1-6)
    - [x] 无效值返回 INVALID_ARGUMENT
  - 错误处理:
    - [x] 原子写入: 失败不影响原文件
  - 测试:
    - [x] 部分更新测试
    - [x] 边界值校验测试
- **备注**:

---

### P6-3: 前端设置页面
- **状态**: [x]
- **类型**: 前端
- **等级**: L1 (基础层)
- **依赖**: P6-1, P6-2
- **描述**: 设置界面
- **产出**:
  - `src/components/settings/SettingsDialog.tsx`
  - 字段:
    - 默认下载目录 (选择器)
    - 最大并发数 (1-6 滑块)
    - 连接超时 (输入框)
    - 日志级别 (下拉)
  - 保存按钮
- **验收标准**:
  - 功能:
    - [x] 加载时显示当前设置值
    - [x] 默认下载目录: 文件夹选择器
    - [x] 最大并发数: 滑块 1-6
    - [x] 连接超时: 数字输入框
    - [x] 日志级别: 下拉选择
    - [x] 保存按钮提交更新
    - [x] 保存成功 Toast 提示
  - 边界条件:
    - [x] 无变更时保存按钮禁用
    - [x] 输入验证: 超时 ≥1s
    - [x] 加载失败显示错误
  - 可维护:
    - [x] 表单使用 react-hook-form
    - [x] 字段校验使用 zod
  - 测试:
    - [x] 表单渲染测试 (V2 - 复杂表单)
    - [x] 保存流程测试 (useSettings.test.tsx)
- **备注**: 已集成 tauri-plugin-dialog

---

### P6-4: 前端设置状态管理
- **状态**: [x]
- **类型**: 前端
- **等级**: L1 (基础层)
- **依赖**: P6-1, P6-2
- **描述**: 设置数据状态管理
- **产出**:
  - `src/hooks/useSettings.ts`
  - `src/lib/settings.ts`
  - 应用启动时加载
  - 提供更新方法
- **验收标准**:
  - 功能:
    - [x] 应用启动时自动加载设置
    - [x] 提供 settings 数据访问
    - [x] 提供 updateSettings 方法
    - [x] 更新后自动刷新缓存
  - 性能:
    - [x] 设置缓存，避免重复请求
  - 可维护:
    - [x] TypeScript 类型完整
    - [x] 使用 TanStack Query 管理
  - 测试:
    - [x] 加载测试 (useSettings.test.tsx)
    - [x] 更新测试 (useSettings.test.tsx)
- **备注**:

---

